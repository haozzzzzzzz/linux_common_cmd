---
typora-copy-images-to: ./pic_aws_ec2_auto_scaling
---

# AWS EC2 Auto Scaling 配置流程

## 创建服务容器映像

- 选中EC2>映像>AMI中选择名为vb-app-base的映像，选择操作“启动”

- 选择实例类型t2.micro。进入下一步。

- 设置“自动分配公有ip”为“禁用”

- 子网选择一个private子网.

- 选择IAM角色为ec2-app-xray-s3-cloudwatch。进入下一步。

- 添加存储保持默认。进入下一步。

- 添加标签。进入下一步。

  | key        | value                   |
  | ---------- | ----------------------- |
  | project    | videobuddy              |
  | department | oversea                 |
  | Name       | vb-private-event-report |

- 选择现有安全组sg-b15a6edavidbuddy app rule。点击审核和启动。



## 登入主机

登入主机部署环境，参考event_report的自动化部署脚本。所有依赖服务必须开机启动。



## 创建ALB

- 点击操作：负载均衡》负载均衡器》创建负载均衡器》应用程序负载均衡器创建

  | 配置项                 | 配置值                                                       |
  | ---------------------- | ------------------------------------------------------------ |
  | 名称                   | vb-<服务名>                                                  |
  | 模式                   | 内部                                                         |
  | IP地址类型             | ipv4                                                         |
  | 侦听器》负载均衡器协议 | 添加服务监听的端口                                           |
  | 可用区                 | 选择可用区ap-south-1a，子网subnet-574d243f（private-subnet-1a）；可用区ap-south-1b，子网subnet-c5cc1289(private-subnet-1b) |
  | 添加标签               | department、project、Name                                    |

  

- 点击配置安全设置，然后点击下一步配置安全组

- 选择现有安全组sg-b15a6eda, vidbuddy app rule。点击下一步配置路由

- 新建目标组

  | 配置项         | 配置值                |
  | -------------- | --------------------- |
  | 目标组         | 新建目标组            |
  | 名称           | vb-<服务名>           |
  | 协议           | HTTP                  |
  | 端口           | 服务占用端口，如18105 |
  | 目标类型       | instance              |
  | 运行状况检协议 | HTTP                  |
  | 运行状况路径   | metrics url           |

- 点击下一步，注册目标。

- 选择服务目标主机，点击添加到已注册。点下一步审核

- 审核完成，点击创建。



注意，创建完成后访问url测试通过后，可以删除主机，然后使用弹性伸缩进行目标管理。



## 创建虚拟机镜像

- 点击操作：实例》选择示例》操作》映像》创建映像

  | 配置项   | 配置值      |
  | -------- | ----------- |
  | 映像名称 | vb-<服务名> |
  | 映像描述 | 描述        |
  | 不重启   | 是          |

- 添加完成后，给映像添加department、project、Name标签。



## 创建Auto Scaling启动配置

- 点击操作：AUTO SCALING > 启动配置 > 创建启动配置。

- 选择AMI（映像）》我的AMI》创建的映像

- 选择实例类型〉t2.micro，点击下一步配置信息。

- 填写配置信息

  | 配置项           | 配置值                                               |
  | ---------------- | ---------------------------------------------------- |
  | 名称             | vb-<服务名>-<版本>。如vb-private-config-2018-07-02-1 |
  | IAM角色          | ec2-app-xray-s3-cloudwatch                           |
  | 监控             | 选择CloudWatch监控                                   |
  | 高级》IP地址类型 | 不向任何示例分配共有IP地址                           |

- 点击下一步添加存储。

- 点击下一步添加安全组。选择现有的安全组sg-b15a6eda（vidbuddy app rule）。点击下一步审核。

- 在审核中注意启动配置详细信息中的IP地址类型是否为“不向任何实例分配公有IP地址”，如果不是点击编辑修改为此值。

- 点击创建启动，选择现有密钥vbapp001，并点击确认勾选框。点击创建启动配置



## 创建Auto Scaling组

- AUTO SCALING > Auto Scaling组>创建Auto Scaling组

- 选择启动配置》使用现有启动配置，选择刚刚创建的启动配置。点击进入下一步.

- 填写详细信息

  | 配置项 | 配置值                             |
  | ------ | ---------------------------------- |
  | 组名   | vb-<服务名>；例如vb-private-config |
  | 组大小 | 从1个实例开始                      |
  | 网络   | 保持默认                           |
  | 子网   | subnet-574d243f,subnet-c5cc1289    |

  

- 填写高级详细信息

  | 配置项                  | 配置值                                   |
  | ----------------------- | ---------------------------------------- |
  | 负载均衡                | 选择从一个活多个负载均衡器接收流量       |
  | 目标组                  | 选择刚才创建的目标组.如vb-private-config |
  | 运行状况检查类型        | 选择EC2                                  |
  | 启用CloundWatch详细监控 | 选择                                     |

  

- 点击下一步：配置扩展策略

- 选择扩展策略，在1和2个实例之间进行扩展。

若选择目标跟踪扩展策略。让平均cpu利用率保持在50%



（选择）若选择使用“分布或简单扩展策略扩展Auto Scaling组”

- 新建增加组大小策略，当平均CPU使用率达到90时添加一个实例。
- 新增减小组策略，当平均CPU使用率小于40%时减少一个实例。



- 点击下一步配置通知。
- 点击添加通知。选择发送通知到alert，全选启动、终止、无法启动、无法终止
- 点击下一步配置标签。project、department、name。
- 创建完成后，记得将之前测试alb的主机衣橱，全部使用auto scaling创建的主机。



接下来你可能需要做的

- 添加consul